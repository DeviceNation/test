Java.perform(function () {
    var ImageReader = Java.use('android.media.ImageReader');

    ImageReader.setOnImageAvailableListener.implementation = function (listener, handler) {
        console.log('setOnImageAvailableListener called');

        var Listener = Java.use('android.media.ImageReader$OnImageAvailableListener');
        var CustomListener = Java.registerClass({
            name: 'com.example.CustomImageAvailableListener',
            implements: [Listener],
            methods: {
                onImageAvailable: function (reader) {
                    console.log('Custom listener: New image available');

                    var image = reader.acquireLatestImage();
                    if (image !== null) {
                        var buffer = image.getPlanes()[0].getBuffer();
                        var byteArray = createCustomImageData(buffer.capacity());
                        
                        // Overwrite the existing image buffer
                        buffer.rewind();
                        buffer.put(byteArray);
                        buffer.rewind();

                        console.log('Custom image injected');
                        image.close();
                    }

                    // Call the original listener's functionality to ensure no loss of functionality
                    listener.onImageAvailable(reader);
                }
            }
        });

        // Replace the original listener with the custom listener
        this.setOnImageAvailableListener(CustomListener.$new(), handler);
    };

    // Helper function to create a custom image data
    function createCustomImageData(size) {
        var byteArray = Java.array('byte', Array(size).fill(0));
        for (var i = 0; i < size; i++) {
            byteArray[i] = (i % 256); // Simple grayscale pattern, replace with actual image data
        }
        return byteArray;
    }
});