Java.perform(function () {
    var ImageReader = Java.use('android.media.ImageReader');

    ImageReader.setOnImageAvailableListener.implementation = function (listener, handler) {
        console.log('setOnImageAvailableListener called');

        var Listener = Java.use('android.media.ImageReader$OnImageAvailableListener');
        var CustomListener = Java.registerClass({
            name: 'com.example.CustomImageAvailableListener',
            implements: [Listener],
            methods: {
                onImageAvailable: function (reader) {
                    console.log('Custom listener: New image available');

                    var image = reader.acquireLatestImage();
                    if (image === null) {
                        console.log('No image available to manipulate.');
                        listener.onImageAvailable(reader);
                        return;
                    }

                    try {
                        var planes = image.getPlanes();
                        var buffer = planes[0].getBuffer();
                        console.log('Image buffer capacity: ' + buffer.capacity());

                        var byteArray = createCustomImageData(buffer.capacity());
                        
                        buffer.rewind();
                        buffer.put(byteArray);
                        buffer.rewind();

                        console.log('Custom image injected');
                    } catch (e) {
                        console.error('Error injecting image: ' + e.message);
                    } finally {
                        image.close();
                    }

                    listener.onImageAvailable(reader);
                }
            }
        });

        this.setOnImageAvailableListener(CustomListener.$new(), handler);
    };

    function createCustomImageData(size) {
        var byteArray = Java.array('byte', Array(size).fill(0));
        for (var i = 0; i < size; i++) {
            byteArray[i] = (i % 256); // Simple grayscale pattern
        }
        console.log('Custom image data created with size: ' + size);
        return byteArray;
    }
});